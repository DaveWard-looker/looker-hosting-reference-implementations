# GCP Project Setup as a code

This guide will walk you through how to use the provided terraform scripts to have the project and required settings created and set for you.


## Prerequisites

You will need:

- The Project Creator GCP role and a suitable Billing Account.
- A valid Looker License Key - please work with your GCP account team if you do not have one.
- The [gcloud command line tool](https://cloud.google.com/sdk/docs/install) installed.
- [Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli) installed. Ensure version is >= 1.3.0

## Deploy the required infrastructure

Navigate to the `terraform/project_creation` folder

### Step 1: Create your `.tfvars` file

```
project_id           = "my-gcp-project-id"
parent               = "parent"
location             = "europe-west3"
repository_id        = "your-repository-name"
sa_name              = "your-service-account-name"
impersonator         = "your-account-thats-used-to-impersonate"
dns_zone             = "your-dns-zone"
dns_domain           = "your-dns-domain."
billing_account      = "your-billing-account-id"
```

Variable definitions are as follow:
| Name | Description | Default |
|------|-------------|---------|
| project_id | Your GCP Project ID |  |
| parent | Your projects parent ||
| location | Your projects region||
|repository_id| Artifact registry repository name where looker images are stored| `looker` |
|sa_name| Service accounts name that will be created with all the required permissions ||
|email_address| Username that will impersonate the created service account [see step highlighted here](https://linktoguide) ||
|dns_zone| Your DNS zone||
|dns_domain| Your DNS domain ||
|billing_account| The billing account the project will be tied to ||

Additional variables defined - only add if you want to alter the default values:
| Name | Description | Default |
|------|-------------|---------|
| roles | Adds the required permissions to the service account created ||


### Step 2: Deploy the infrastructure

1. You will need to initialize Terraform before applying - you will only need to do this once. Execute the following command:

```
$ terraform init
```

2. Next, run the plan to make sure your configuration is valid. Execute the following command:

```
$ terraform plan
```

3. If your plan comes back successfully it is time to deploy! Execute the following command:

```
$ terraform apply
```

The deployment will take around 5-10 minutes.

### Step 3: Populate the secrets

While deploying the project, we have created three secrets which will be used in the coming steps. Navigate to the secret manager in the Google Cloud console and give each secret their value:

1. A strong password (to be used as a password for Looker's MySQL account). This password should include only alphanumeric characters - no special characters!
2. Your Looker License Key
3. A GCM Encryption Key - this can be generated by running the command `openssl rand -base64 32`. See Looker's [encryption documentation](https://docs.looker.com/setup-and-management/on-prem-mgmt/migrating-encryption#generating_a_cmk) for more details.

It was opted to not add the values while deploying as code. This would be possible, but requires the secret values to be stored in your vars file which is not recommended.

## Further information/ToDo

- The provided script really is the minimal way to configure this using preexisting modules from the [cloud foundation fabric](https://github.com/GoogleCloudPlatform/cloud-foundation-fabric)
- To move more towards production, the tfstate should be stored remotely
- TBD